<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="820px" preserveAspectRatio="none" style="width:1036px;height:820px;background:#FFFFFF;" version="1.1" viewBox="0 0 1036 820" width="1036px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="696.9004" style="stroke:#181818;stroke-width:1.0;" width="10" x="309.5" y="98.7988"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="474.5" y="170.4199"/><rect fill="#FFFFFF" height="537.3477" style="stroke:#181818;stroke-width:1.0;" width="10" x="622.5" y="229.041"/><rect fill="#FFFFFF" height="56.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="627.5" y="391.5938"/><rect fill="#FFFFFF" height="245.8633" style="stroke:#181818;stroke-width:1.0;" width="10" x="627.5" y="499.2148"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="977.5" y="666.7676"/><rect fill="none" height="218.8633" style="stroke:#000000;stroke-width:1.5;" width="476" x="554" y="244.041"/><rect fill="none" height="102.9316" style="stroke:#000000;stroke-width:1.5;" width="456" x="564" y="352.9727"/><rect fill="none" height="218.8633" style="stroke:#000000;stroke-width:1.5;" width="476" x="554" y="519.2148"/><rect fill="none" height="145.2422" style="stroke:#000000;stroke-width:1.5;" width="456" x="564" y="585.8359"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="67" x2="67" y1="67.4883" y2="813.6992"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="314" x2="314" y1="67.4883" y2="813.6992"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="479" x2="479" y1="67.4883" y2="813.6992"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="627" x2="627" y1="67.4883" y2="813.6992"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="982" x2="982" y1="67.4883" y2="813.6992"/><rect fill="#E3E3E3" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="85" x="25" y="36"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="71" x="32" y="56.5352">Consumer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="266" y="64.5352">Entity Pattern</text><ellipse cx="314.5" cy="35" fill="#E3E3E3" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><polygon fill="#181818" points="310.5,23,316.5,18,314.5,23,316.5,28,310.5,23" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#E3E3E3" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="129" x="415" y="36"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="115" x="422" y="56.5352">Cluster Sharding</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="101" x="574" y="64.5352">Entity Behavior</text><ellipse cx="627.5" cy="35" fill="#E3E3E3" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><line style="stroke:#181818;stroke-width:0.5;" x1="615.5" x2="639.5" y1="49" y2="49"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="49" x="955" y="64.5352">Journal</text><path d="M964.5,15 C964.5,5 982.5,5 982.5,5 C982.5,5 1000.5,5 1000.5,15 L1000.5,41 C1000.5,51 982.5,51 982.5,51 C982.5,51 964.5,51 964.5,41 L964.5,15 " fill="#E3E3E3" style="stroke:#181818;stroke-width:1.5;"/><path d="M964.5,15 C964.5,25 982.5,25 982.5,25 C982.5,25 1000.5,25 1000.5,15 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><rect fill="#FFFFFF" height="696.9004" style="stroke:#181818;stroke-width:1.0;" width="10" x="309.5" y="98.7988"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="474.5" y="170.4199"/><rect fill="#FFFFFF" height="537.3477" style="stroke:#181818;stroke-width:1.0;" width="10" x="622.5" y="229.041"/><rect fill="#FFFFFF" height="56.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="627.5" y="391.5938"/><rect fill="#FFFFFF" height="245.8633" style="stroke:#181818;stroke-width:1.0;" width="10" x="627.5" y="499.2148"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="977.5" y="666.7676"/><polygon fill="#181818" points="297.5,94.7988,307.5,98.7988,297.5,102.7988,301.5,98.7988" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="67.5" x2="303.5" y1="98.7988" y2="98.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="77" y="94.0566">? (</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="90" y="94.0566">entityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="49" x="142" y="94.0566">: String,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="195" y="94.0566">cmd</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="224" y="94.0566">: Command)</text><line style="stroke:#181818;stroke-width:1.0;" x1="319.5" x2="361.5" y1="128.1094" y2="128.1094"/><line style="stroke:#181818;stroke-width:1.0;" x1="361.5" x2="361.5" y1="128.1094" y2="141.1094"/><line style="stroke:#181818;stroke-width:1.0;" x1="320.5" x2="361.5" y1="141.1094" y2="141.1094"/><polygon fill="#181818" points="330.5,137.1094,320.5,141.1094,330.5,145.1094,326.5,141.1094" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="21" x="326.5" y="123.3672">ref(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="347.5" y="123.3672">entityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="399.5" y="123.3672">)</text><polygon fill="#181818" points="462.5,166.4199,472.5,170.4199,462.5,174.4199,466.5,170.4199" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="319.5" x2="468.5" y1="170.4199" y2="170.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80" x="329" y="165.6777">entityRefFor(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="409" y="165.6777">entityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="461" y="165.6777">)</text><polygon fill="#181818" points="330.5,195.7305,320.5,199.7305,330.5,203.7305,326.5,199.7305" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="324.5" x2="478.5" y1="199.7305" y2="199.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="372" y="194.9883">recipient</text><polygon fill="#181818" points="610.5,225.041,620.5,229.041,610.5,233.041,614.5,229.041" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="319.5" x2="616.5" y1="229.041" y2="229.041"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="5" x="452" y="224.2988">?</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="461" y="224.2988">cmd</text><path d="M554,244.041 L621,244.041 L621,251.3516 L611,261.3516 L554,261.3516 L554,244.041 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="218.8633" style="stroke:#000000;stroke-width:1.5;" width="476" x="554" y="244.041"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="569" y="257.6094">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="224" x="636" y="256.6758">[recovering from latest saved snapshot]</text><line style="stroke:#181818;stroke-width:1.0;" x1="632.5" x2="674.5" y1="282.6621" y2="282.6621"/><line style="stroke:#181818;stroke-width:1.0;" x1="674.5" x2="674.5" y1="282.6621" y2="295.6621"/><line style="stroke:#181818;stroke-width:1.0;" x1="633.5" x2="674.5" y1="295.6621" y2="295.6621"/><polygon fill="#181818" points="643.5,291.6621,633.5,295.6621,643.5,299.6621,639.5,295.6621" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="639.5" y="277.9199">stash</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="677.5" y="277.9199">cmd</text><line style="stroke:#181818;stroke-width:1.0;" x1="632.5" x2="674.5" y1="324.9727" y2="324.9727"/><line style="stroke:#181818;stroke-width:1.0;" x1="674.5" x2="674.5" y1="324.9727" y2="337.9727"/><line style="stroke:#181818;stroke-width:1.0;" x1="633.5" x2="674.5" y1="337.9727" y2="337.9727"/><polygon fill="#181818" points="643.5,333.9727,633.5,337.9727,643.5,341.9727,639.5,337.9727" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="639.5" y="320.2305">initialize entity</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="33" x="737.5" y="320.2305">state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="774.5" y="320.2305">with the latest saved</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="62" x="908.5" y="320.2305">snapshot</text><path d="M564,352.9727 L638,352.9727 L638,360.2832 L628,370.2832 L564,370.2832 L564,352.9727 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="102.9316" style="stroke:#000000;stroke-width:1.5;" width="456" x="564" y="352.9727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="579" y="366.541">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="216" x="653" y="365.6074">[all events after latest saved snapshot]</text><polygon fill="#181818" points="648.5,387.5938,638.5,391.5938,648.5,395.5938,644.5,391.5938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="642.5" x2="981.5" y1="391.5938" y2="391.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="39" x="790.5" y="386.8516">revent</text><line style="stroke:#181818;stroke-width:1.0;" x1="637.5" x2="679.5" y1="420.9043" y2="420.9043"/><line style="stroke:#181818;stroke-width:1.0;" x1="679.5" x2="679.5" y1="420.9043" y2="433.9043"/><line style="stroke:#181818;stroke-width:1.0;" x1="638.5" x2="679.5" y1="433.9043" y2="433.9043"/><polygon fill="#181818" points="648.5,429.9043,638.5,433.9043,648.5,437.9043,644.5,433.9043" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80" x="644.5" y="416.1621">handleEvent(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="33" x="724.5" y="416.1621">state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="51" x="757.5" y="416.1621">, revent)</text><polygon fill="#181818" points="970.5,443.9043,980.5,447.9043,970.5,451.9043,974.5,447.9043" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="632.5" x2="976.5" y1="447.9043" y2="447.9043"/><line style="stroke:#181818;stroke-width:1.0;" x1="632.5" x2="679.5" y1="486.2148" y2="486.2148"/><line style="stroke:#181818;stroke-width:1.0;" x1="679.5" x2="679.5" y1="486.2148" y2="499.2148"/><line style="stroke:#181818;stroke-width:1.0;" x1="638.5" x2="679.5" y1="499.2148" y2="499.2148"/><polygon fill="#181818" points="648.5,495.2148,638.5,499.2148,648.5,503.2148,644.5,499.2148" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="110" x="644.5" y="481.4727">handleCommand(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="754.5" y="481.4727">cmd</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="783.5" y="481.4727">)</text><path d="M554,519.2148 L621,519.2148 L621,526.5254 L611,536.5254 L554,536.5254 L554,519.2148 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="218.8633" style="stroke:#000000;stroke-width:1.5;" width="476" x="554" y="519.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="569" y="532.7832">opt</text><line style="stroke:#181818;stroke-width:1.0;" x1="637.5" x2="679.5" y1="557.8359" y2="557.8359"/><line style="stroke:#181818;stroke-width:1.0;" x1="679.5" x2="679.5" y1="557.8359" y2="570.8359"/><line style="stroke:#181818;stroke-width:1.0;" x1="638.5" x2="679.5" y1="570.8359" y2="570.8359"/><polygon fill="#181818" points="648.5,566.8359,638.5,570.8359,648.5,574.8359,644.5,570.8359" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="644.5" y="553.0938">persist(events)</text><path d="M564,585.8359 L638,585.8359 L638,593.1465 L628,603.1465 L564,603.1465 L564,585.8359 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="145.2422" style="stroke:#000000;stroke-width:1.5;" width="456" x="564" y="585.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="579" y="599.4043">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="119" x="653" y="598.4707">[for event &lt;- events]</text><line style="stroke:#181818;stroke-width:1.0;" x1="637.5" x2="679.5" y1="624.457" y2="624.457"/><line style="stroke:#181818;stroke-width:1.0;" x1="679.5" x2="679.5" y1="624.457" y2="637.457"/><line style="stroke:#181818;stroke-width:1.0;" x1="638.5" x2="679.5" y1="637.457" y2="637.457"/><polygon fill="#181818" points="648.5,633.457,638.5,637.457,648.5,641.457,644.5,637.457" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="644.5" y="619.7148">tagEvent(event)</text><polygon fill="#181818" points="965.5,662.7676,975.5,666.7676,965.5,670.7676,969.5,666.7676" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="637.5" x2="971.5" y1="666.7676" y2="666.7676"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="732" y="662.0254">persist event with tag(s)</text><polygon fill="#181818" points="648.5,676.7676,638.5,680.7676,648.5,684.7676,644.5,680.7676" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="642.5" x2="981.5" y1="680.7676" y2="680.7676"/><line style="stroke:#181818;stroke-width:1.0;" x1="637.5" x2="679.5" y1="710.0781" y2="710.0781"/><line style="stroke:#181818;stroke-width:1.0;" x1="679.5" x2="679.5" y1="710.0781" y2="723.0781"/><line style="stroke:#181818;stroke-width:1.0;" x1="638.5" x2="679.5" y1="723.0781" y2="723.0781"/><polygon fill="#181818" points="648.5,719.0781,638.5,723.0781,648.5,727.0781,644.5,723.0781" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80" x="644.5" y="705.3359">handleEvent(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="33" x="724.5" y="705.3359">state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="757.5" y="705.3359">, event)</text><polygon fill="#181818" points="330.5,762.3887,320.5,766.3887,330.5,770.3887,326.5,766.3887" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="324.5" x2="626.5" y1="766.3887" y2="766.3887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="39" x="398.5" y="761.6465">result</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="437.5" y="761.6465">: CommandResult</text><polygon fill="#181818" points="78.5,791.6992,68.5,795.6992,78.5,799.6992,74.5,795.6992" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="72.5" x2="313.5" y1="795.6992" y2="795.6992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="39" x="116" y="790.957">result</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="155" y="790.957">: CommandResult</text><!--MD5=[e4eb35a67b1385f964cfb5bbf94b8691]
@startuml EventSourcing
hide footbox
skinparam ParticipantPadding 20
skinparam BoxPadding 10
skinparam sequenceMessageAlign center
skinparam monochrome true

participant Consumer as c
control "Entity Pattern" as ep
participant "Cluster Sharding" as cs
entity "Entity Behavior" as eb
database Journal as j

c -> ep++: ? (**entityId**: String, **cmd**: Command)
ep -> ep : ref(**entityId**)
ep -> cs++: entityRefFor(**entityId**)
return recipient
ep -> eb++: ? **cmd**

opt recovering from latest saved snapshot
eb -> eb: stash **cmd**
eb -> eb: initialize entity **state** with the latest saved **snapshot**
loop all events after latest saved snapshot
j -> eb++: revent
eb -> eb: handleEvent(**state**, revent)
eb - -> j- -
end
end

eb -> eb++: handleCommand(**cmd**)
opt
eb -> eb: persist(events)
loop for event <- events
eb -> eb: tagEvent(event)
eb -> j++: persist event with tag(s)
return
eb -> eb: handleEvent(**state**, event)
end
end
eb- -
return **result**: CommandResult
return **result**: CommandResult

@enduml

PlantUML version 1.2022.12(Sun Oct 23 20:12:26 CEST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: fr
Country: FR
--></g></svg>