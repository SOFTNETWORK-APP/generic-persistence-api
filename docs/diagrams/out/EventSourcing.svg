<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="820px" preserveAspectRatio="none" style="width:1136px;height:820px;background:#FFFFFF;" version="1.1" viewBox="0 0 1136 820" width="1136px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="696.9004" style="stroke:#181818;stroke-width:1.0;" width="10" x="298" y="98.7988"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="559" y="170.4199"/><rect fill="#FFFFFF" height="537.3477" style="stroke:#181818;stroke-width:1.0;" width="10" x="707" y="229.041"/><rect fill="#FFFFFF" height="56.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="712" y="391.5938"/><rect fill="#FFFFFF" height="245.8633" style="stroke:#181818;stroke-width:1.0;" width="10" x="712" y="499.2148"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="1078" y="666.7676"/><rect fill="none" height="218.8633" style="stroke:#000000;stroke-width:1.5;" width="492" x="638.5" y="244.041"/><rect fill="none" height="102.9316" style="stroke:#000000;stroke-width:1.5;" width="472" x="648.5" y="352.9727"/><rect fill="none" height="218.8633" style="stroke:#000000;stroke-width:1.5;" width="492" x="638.5" y="519.2148"/><rect fill="none" height="145.2422" style="stroke:#000000;stroke-width:1.5;" width="472" x="648.5" y="585.8359"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="56" x2="56" y1="67.4883" y2="813.6992"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="302.5" x2="302.5" y1="67.4883" y2="813.6992"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="563.5" x2="563.5" y1="67.4883" y2="813.6992"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="711.5" x2="711.5" y1="67.4883" y2="813.6992"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1082.5" x2="1082.5" y1="67.4883" y2="813.6992"/><rect fill="#E3E3E3" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="62" x="25" y="36"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="32" y="56.5352">Sender</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="254.5" y="64.5352">Entity Pattern</text><ellipse cx="303" cy="35" fill="#E3E3E3" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><polygon fill="#181818" points="299,23,305,18,303,23,305,28,299,23" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#E3E3E3" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="129" x="499.5" y="36"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="115" x="506.5" y="56.5352">Cluster Sharding</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="101" x="658.5" y="64.5352">Entity Behavior</text><ellipse cx="712" cy="35" fill="#E3E3E3" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><line style="stroke:#181818;stroke-width:0.5;" x1="700" x2="724" y1="49" y2="49"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="49" x="1055.5" y="64.5352">Journal</text><path d="M1065,15 C1065,5 1083,5 1083,5 C1083,5 1101,5 1101,15 L1101,41 C1101,51 1083,51 1083,51 C1083,51 1065,51 1065,41 L1065,15 " fill="#E3E3E3" style="stroke:#181818;stroke-width:1.5;"/><path d="M1065,15 C1065,25 1083,25 1083,25 C1083,25 1101,25 1101,15 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><rect fill="#FFFFFF" height="696.9004" style="stroke:#181818;stroke-width:1.0;" width="10" x="298" y="98.7988"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="559" y="170.4199"/><rect fill="#FFFFFF" height="537.3477" style="stroke:#181818;stroke-width:1.0;" width="10" x="707" y="229.041"/><rect fill="#FFFFFF" height="56.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="712" y="391.5938"/><rect fill="#FFFFFF" height="245.8633" style="stroke:#181818;stroke-width:1.0;" width="10" x="712" y="499.2148"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="1078" y="666.7676"/><polygon fill="#181818" points="286,94.7988,296,98.7988,286,102.7988,290,98.7988" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="56" x2="292" y1="98.7988" y2="98.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="65.5" y="94.0566">? (</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="78.5" y="94.0566">entityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="49" x="130.5" y="94.0566">: String,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="183.5" y="94.0566">cmd</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="212.5" y="94.0566">: Command)</text><line style="stroke:#181818;stroke-width:1.0;" x1="308" x2="350" y1="128.1094" y2="128.1094"/><line style="stroke:#181818;stroke-width:1.0;" x1="350" x2="350" y1="128.1094" y2="141.1094"/><line style="stroke:#181818;stroke-width:1.0;" x1="309" x2="350" y1="141.1094" y2="141.1094"/><polygon fill="#181818" points="319,137.1094,309,141.1094,319,145.1094,315,141.1094" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="21" x="315" y="123.3672">ref(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="336" y="123.3672">entityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="388" y="123.3672">)</text><polygon fill="#181818" points="547,166.4199,557,170.4199,547,174.4199,551,170.4199" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308" x2="553" y1="170.4199" y2="170.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="317.5" y="165.6777">entityRefFor(entityTypeKey,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="493.5" y="165.6777">entityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="545.5" y="165.6777">)</text><polygon fill="#181818" points="319,195.7305,309,199.7305,319,203.7305,315,199.7305" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313" x2="563" y1="199.7305" y2="199.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="387" y="194.9883">entity reference</text><polygon fill="#181818" points="695,225.041,705,229.041,695,233.041,699,229.041" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="308" x2="701" y1="229.041" y2="229.041"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="5" x="488.5" y="224.2988">?</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="497.5" y="224.2988">cmd</text><path d="M638.5,244.041 L705.5,244.041 L705.5,251.3516 L695.5,261.3516 L638.5,261.3516 L638.5,244.041 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="218.8633" style="stroke:#000000;stroke-width:1.5;" width="492" x="638.5" y="244.041"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="653.5" y="257.6094">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="224" x="720.5" y="256.6758">[recovering from latest saved snapshot]</text><line style="stroke:#181818;stroke-width:1.0;" x1="717" x2="759" y1="282.6621" y2="282.6621"/><line style="stroke:#181818;stroke-width:1.0;" x1="759" x2="759" y1="282.6621" y2="295.6621"/><line style="stroke:#181818;stroke-width:1.0;" x1="718" x2="759" y1="295.6621" y2="295.6621"/><polygon fill="#181818" points="728,291.6621,718,295.6621,728,299.6621,724,295.6621" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="724" y="277.9199">stash</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="762" y="277.9199">cmd</text><line style="stroke:#181818;stroke-width:1.0;" x1="717" x2="759" y1="324.9727" y2="324.9727"/><line style="stroke:#181818;stroke-width:1.0;" x1="759" x2="759" y1="324.9727" y2="337.9727"/><line style="stroke:#181818;stroke-width:1.0;" x1="718" x2="759" y1="337.9727" y2="337.9727"/><polygon fill="#181818" points="728,333.9727,718,337.9727,728,341.9727,724,337.9727" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="724" y="320.2305">initialize entity</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="33" x="822" y="320.2305">state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="859" y="320.2305">with the latest saved</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="62" x="993" y="320.2305">snapshot</text><path d="M648.5,352.9727 L722.5,352.9727 L722.5,360.2832 L712.5,370.2832 L648.5,370.2832 L648.5,352.9727 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="102.9316" style="stroke:#000000;stroke-width:1.5;" width="472" x="648.5" y="352.9727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="663.5" y="366.541">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="216" x="737.5" y="365.6074">[all events after latest saved snapshot]</text><polygon fill="#181818" points="733,387.5938,723,391.5938,733,395.5938,729,391.5938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="727" x2="1082" y1="391.5938" y2="391.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="39" x="883" y="386.8516">revent</text><line style="stroke:#181818;stroke-width:1.0;" x1="722" x2="764" y1="420.9043" y2="420.9043"/><line style="stroke:#181818;stroke-width:1.0;" x1="764" x2="764" y1="420.9043" y2="433.9043"/><line style="stroke:#181818;stroke-width:1.0;" x1="723" x2="764" y1="433.9043" y2="433.9043"/><polygon fill="#181818" points="733,429.9043,723,433.9043,733,437.9043,729,433.9043" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80" x="729" y="416.1621">handleEvent(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="33" x="809" y="416.1621">state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="51" x="842" y="416.1621">, revent)</text><polygon fill="#181818" points="1071,443.9043,1081,447.9043,1071,451.9043,1075,447.9043" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="717" x2="1077" y1="447.9043" y2="447.9043"/><line style="stroke:#181818;stroke-width:1.0;" x1="717" x2="764" y1="486.2148" y2="486.2148"/><line style="stroke:#181818;stroke-width:1.0;" x1="764" x2="764" y1="486.2148" y2="499.2148"/><line style="stroke:#181818;stroke-width:1.0;" x1="723" x2="764" y1="499.2148" y2="499.2148"/><polygon fill="#181818" points="733,495.2148,723,499.2148,733,503.2148,729,499.2148" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="110" x="729" y="481.4727">handleCommand(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="839" y="481.4727">entityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="891" y="481.4727">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="33" x="899" y="481.4727">state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="932" y="481.4727">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="940" y="481.4727">cmd</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="969" y="481.4727">, replyTo, timers)</text><path d="M638.5,519.2148 L705.5,519.2148 L705.5,526.5254 L695.5,536.5254 L638.5,536.5254 L638.5,519.2148 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="218.8633" style="stroke:#000000;stroke-width:1.5;" width="492" x="638.5" y="519.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="653.5" y="532.7832">opt</text><line style="stroke:#181818;stroke-width:1.0;" x1="722" x2="764" y1="557.8359" y2="557.8359"/><line style="stroke:#181818;stroke-width:1.0;" x1="764" x2="764" y1="557.8359" y2="570.8359"/><line style="stroke:#181818;stroke-width:1.0;" x1="723" x2="764" y1="570.8359" y2="570.8359"/><polygon fill="#181818" points="733,566.8359,723,570.8359,733,574.8359,729,570.8359" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="729" y="553.0938">persist(events)</text><path d="M648.5,585.8359 L722.5,585.8359 L722.5,593.1465 L712.5,603.1465 L648.5,603.1465 L648.5,585.8359 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="145.2422" style="stroke:#000000;stroke-width:1.5;" width="472" x="648.5" y="585.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="663.5" y="599.4043">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="119" x="737.5" y="598.4707">[for event &lt;- events]</text><line style="stroke:#181818;stroke-width:1.0;" x1="722" x2="764" y1="624.457" y2="624.457"/><line style="stroke:#181818;stroke-width:1.0;" x1="764" x2="764" y1="624.457" y2="637.457"/><line style="stroke:#181818;stroke-width:1.0;" x1="723" x2="764" y1="637.457" y2="637.457"/><polygon fill="#181818" points="733,633.457,723,637.457,733,641.457,729,637.457" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="729" y="619.7148">tagEvent(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="787" y="619.7148">entityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="839" y="619.7148">, event)</text><polygon fill="#181818" points="1066,662.7676,1076,666.7676,1066,670.7676,1070,666.7676" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="722" x2="1072" y1="666.7676" y2="666.7676"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="824.5" y="662.0254">persist event with tag(s)</text><polygon fill="#181818" points="733,676.7676,723,680.7676,733,684.7676,729,680.7676" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="727" x2="1082" y1="680.7676" y2="680.7676"/><line style="stroke:#181818;stroke-width:1.0;" x1="722" x2="764" y1="710.0781" y2="710.0781"/><line style="stroke:#181818;stroke-width:1.0;" x1="764" x2="764" y1="710.0781" y2="723.0781"/><line style="stroke:#181818;stroke-width:1.0;" x1="723" x2="764" y1="723.0781" y2="723.0781"/><polygon fill="#181818" points="733,719.0781,723,723.0781,733,727.0781,729,723.0781" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80" x="729" y="705.3359">handleEvent(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="33" x="809" y="705.3359">state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="842" y="705.3359">, event)</text><polygon fill="#181818" points="319,762.3887,309,766.3887,319,770.3887,315,766.3887" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="313" x2="711" y1="766.3887" y2="766.3887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="39" x="435" y="761.6465">result</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="474" y="761.6465">: CommandResult</text><polygon fill="#181818" points="67,791.6992,57,795.6992,67,799.6992,63,795.6992" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="61" x2="302" y1="795.6992" y2="795.6992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="39" x="104.5" y="790.957">result</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="143.5" y="790.957">: CommandResult</text><!--MD5=[8f2a6cbbc4632f08c37e1658a0ee20d5]
@startuml EventSourcing
hide footbox
skinparam ParticipantPadding 20
skinparam BoxPadding 10
skinparam sequenceMessageAlign center
skinparam monochrome true

participant Sender as s
control "Entity Pattern" as ep
participant "Cluster Sharding" as cs
entity "Entity Behavior" as eb
database Journal as j

s -> ep++: ? (**entityId**: String, **cmd**: Command)
ep -> ep : ref(**entityId**)
ep -> cs++: entityRefFor(entityTypeKey, **entityId**)
return entity reference
ep -> eb++: ? **cmd**

opt recovering from latest saved snapshot
eb -> eb: stash **cmd**
eb -> eb: initialize entity **state** with the latest saved **snapshot**
loop all events after latest saved snapshot
j -> eb++: revent
eb -> eb: handleEvent(**state**, revent)
eb - -> j- -
end
end

eb -> eb++: handleCommand(**entityId**, **state**, **cmd**, replyTo, timers)
opt
eb -> eb: persist(events)
loop for event <- events
eb -> eb: tagEvent(**entityId**, event)
eb -> j++: persist event with tag(s)
return
eb -> eb: handleEvent(**state**, event)
end
end
eb- -
return **result**: CommandResult
return **result**: CommandResult

@enduml

PlantUML version 1.2022.12(Sun Oct 23 20:12:26 CEST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: fr
Country: FR
--></g></svg>