<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1168px" preserveAspectRatio="none" style="width:1216px;height:1168px;background:#FFFFFF;" version="1.1" viewBox="0 0 1216 1168" width="1216px" zoomAndPan="magnify"><defs/><g><rect fill="#EDEDED" height="1149.4258" style="stroke:#181818;stroke-width:0.5;" width="195" x="11" y="6"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="315.5" y="141.1094"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="315.5" y="265.6621"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="315.5" y="985.1836"/><rect fill="#FFFFFF" height="1045.627" style="stroke:#181818;stroke-width:1.0;" width="10" x="495.5" y="106.7988"/><rect fill="#FFFFFF" height="797.1426" style="stroke:#181818;stroke-width:1.0;" width="10" x="500.5" y="346.2832"/><rect fill="#FFFFFF" height="722.8662" style="stroke:#181818;stroke-width:1.0;" width="10" x="684.5" y="391.249"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="849.5" y="473.5254"/><rect fill="#FFFFFF" height="552.6582" style="stroke:#181818;stroke-width:1.0;" width="10" x="997.5" y="532.1465"/><rect fill="#FFFFFF" height="494.0371" style="stroke:#181818;stroke-width:1.0;" width="10" x="1002.5" y="569.457"/><rect fill="#FFFFFF" height="56.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="1007.5" y="752.3203"/><rect fill="none" height="234.1738" style="stroke:#000000;stroke-width:1.5;" width="937.5" x="273" y="589.457"/><rect fill="none" height="102.9316" style="stroke:#000000;stroke-width:1.5;" width="917.5" x="283" y="713.6992"/><rect fill="none" height="218.8633" style="stroke:#000000;stroke-width:1.5;" width="927.5" x="273" y="837.6309"/><rect fill="none" height="145.2422" style="stroke:#000000;stroke-width:1.5;" width="907.5" x="283" y="904.252"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="108" x2="108" y1="67.4883" y2="1161.4258"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="320" x2="320" y1="67.4883" y2="1161.4258"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="500.5" x2="500.5" y1="67.4883" y2="1161.4258"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="689" x2="689" y1="67.4883" y2="1161.4258"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="854" x2="854" y1="67.4883" y2="1161.4258"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1002" x2="1002" y1="67.4883" y2="1161.4258"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="181" x="15" y="64.5352">External Bounded Context</text><path d="M88,23 L88,47 M88,35 L105,35 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="117" cy="35" fill="#E3E3E3" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="49" x="293" y="64.5352">Journal</text><path d="M302.5,15 C302.5,5 320.5,5 320.5,5 C320.5,5 338.5,5 338.5,15 L338.5,41 C338.5,51 320.5,51 320.5,51 C320.5,51 302.5,51 302.5,41 L302.5,15 " fill="#E3E3E3" style="stroke:#181818;stroke-width:1.5;"/><path d="M302.5,15 C302.5,25 320.5,25 320.5,25 C320.5,25 338.5,25 338.5,15 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><path d="M402.5,8.0234 L598.5,8.0234 C603.5,8.0234 603.5,37.7559 603.5,37.7559 C603.5,37.7559 603.5,67.4883 598.5,67.4883 L402.5,67.4883 C397.5,67.4883 397.5,37.7559 397.5,37.7559 C397.5,37.7559 397.5,8.0234 402.5,8.0234 " fill="#E3E3E3" style="stroke:#181818;stroke-width:0.5;"/><path d="M598.5,8.0234 C593.5,8.0234 593.5,37.7559 593.5,37.7559 C593.5,67.4883 598.5,67.4883 598.5,67.4883 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="475" y="26.5586">Event</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="119" x="436" y="43.0469">Processor Stream</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="186" x="402.5" y="59.5352">tag = 'domain-to-external'</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="641" y="64.5352">Entity Pattern</text><ellipse cx="689.5" cy="35" fill="#E3E3E3" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><polygon fill="#181818" points="685.5,23,691.5,18,689.5,23,691.5,28,685.5,23" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#E3E3E3" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="129" x="790" y="36"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="115" x="797" y="56.5352">Cluster Sharding</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="101" x="949" y="64.5352">Entity Behavior</text><ellipse cx="1002.5" cy="35" fill="#E3E3E3" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><line style="stroke:#181818;stroke-width:0.5;" x1="990.5" x2="1014.5" y1="49" y2="49"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="315.5" y="141.1094"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="315.5" y="265.6621"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="315.5" y="985.1836"/><rect fill="#FFFFFF" height="1045.627" style="stroke:#181818;stroke-width:1.0;" width="10" x="495.5" y="106.7988"/><rect fill="#FFFFFF" height="797.1426" style="stroke:#181818;stroke-width:1.0;" width="10" x="500.5" y="346.2832"/><rect fill="#FFFFFF" height="722.8662" style="stroke:#181818;stroke-width:1.0;" width="10" x="684.5" y="391.249"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="849.5" y="473.5254"/><rect fill="#FFFFFF" height="552.6582" style="stroke:#181818;stroke-width:1.0;" width="10" x="997.5" y="532.1465"/><rect fill="#FFFFFF" height="494.0371" style="stroke:#181818;stroke-width:1.0;" width="10" x="1002.5" y="569.457"/><rect fill="#FFFFFF" height="56.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="1007.5" y="752.3203"/><line style="stroke:#181818;stroke-width:1.0;" x1="500.5" x2="547.5" y1="93.7988" y2="93.7988"/><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="547.5" y1="93.7988" y2="106.7988"/><line style="stroke:#181818;stroke-width:1.0;" x1="506.5" x2="547.5" y1="106.7988" y2="106.7988"/><polygon fill="#181818" points="516.5,102.7988,506.5,106.7988,516.5,110.7988,512.5,106.7988" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="21" x="512.5" y="89.0566">init</text><polygon fill="#181818" points="336.5,137.1094,326.5,141.1094,336.5,145.1094,332.5,141.1094" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="330.5" x2="494.5" y1="141.1094" y2="141.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="373.5" y="136.3672">readOffset()</text><polygon fill="#181818" points="483.5,166.4199,493.5,170.4199,483.5,174.4199,487.5,170.4199" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="320.5" x2="489.5" y1="170.4199" y2="170.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="38" x="389" y="165.6777">offset</text><polygon fill="#181818" points="331.5,206.3857,321.5,210.3857,331.5,214.3857,327.5,210.3857" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="325.5" x2="494.5" y1="210.3857" y2="210.3857"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="332.5" y="205.6436">readEventsByTag(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="38" x="441.5" y="205.6436">offset</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="479.5" y="205.6436">)</text><path d="M510,183.4199 L510,223.4199 L864,223.4199 L864,193.4199 L854,183.4199 L510,183.4199 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><path d="M854,183.4199 L854,193.4199 L864,193.4199 L854,183.4199 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="47" x="516" y="200.9883">stream</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="278" x="567" y="200.9883">of events with the tag "domain-to-external"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="516" y="216.2988">from the specified offset</text><polygon fill="#181818" points="303.5,261.6621,313.5,265.6621,303.5,269.6621,307.5,265.6621" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="108.5" x2="309.5" y1="265.6621" y2="265.6621"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="187" x="118.5" y="245.6094">persist domain event with tag</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="184" x="122" y="260.9199">Set("domain-to-external", ...)</text><polygon fill="#181818" points="119.5,275.6621,109.5,279.6621,119.5,283.6621,115.5,279.6621" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="113.5" x2="319.5" y1="279.6621" y2="279.6621"/><line style="stroke:#181818;stroke-width:1.0;" x1="493.5" x2="483.5" y1="308.9727" y2="304.9727"/><line style="stroke:#181818;stroke-width:1.0;" x1="493.5" x2="483.5" y1="308.9727" y2="312.9727"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="320.5" x2="494.5" y1="308.9727" y2="308.9727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="47" x="384.5" y="304.2305">devent</text><line style="stroke:#181818;stroke-width:1.0;" x1="505.5" x2="552.5" y1="333.2832" y2="333.2832"/><line style="stroke:#181818;stroke-width:1.0;" x1="552.5" x2="552.5" y1="333.2832" y2="346.2832"/><line style="stroke:#181818;stroke-width:1.0;" x1="511.5" x2="552.5" y1="346.2832" y2="346.2832"/><polygon fill="#181818" points="521.5,342.2832,511.5,346.2832,521.5,350.2832,517.5,346.2832" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87" x="517.5" y="328.541">processEvent(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="47" x="604.5" y="328.541">devent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="651.5" y="328.541">)</text><polygon fill="#181818" points="672.5,387.249,682.5,391.249,672.5,395.249,676.5,391.249" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="510.5" x2="678.5" y1="391.249" y2="391.249"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="544.5" y="386.5068">? (</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="557.5" y="386.5068">entityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="609.5" y="386.5068">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="617.5" y="386.5068">cmd</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="646.5" y="386.5068">)</text><path d="M699,364.2832 L699,404.2832 L973,404.2832 L973,374.2832 L963,364.2832 L699,364.2832 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><path d="M963,364.2832 L963,374.2832 L973,374.2832 L963,364.2832 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="705" y="381.8516">entityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="761" y="381.8516">should be specified or inferred</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="705" y="397.1621">from one of the event properties</text><line style="stroke:#181818;stroke-width:1.0;" x1="694.5" x2="736.5" y1="431.2148" y2="431.2148"/><line style="stroke:#181818;stroke-width:1.0;" x1="736.5" x2="736.5" y1="431.2148" y2="444.2148"/><line style="stroke:#181818;stroke-width:1.0;" x1="695.5" x2="736.5" y1="444.2148" y2="444.2148"/><polygon fill="#181818" points="705.5,440.2148,695.5,444.2148,705.5,448.2148,701.5,444.2148" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="21" x="701.5" y="426.4727">ref(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="722.5" y="426.4727">entityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="774.5" y="426.4727">)</text><polygon fill="#181818" points="837.5,469.5254,847.5,473.5254,837.5,477.5254,841.5,473.5254" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="694.5" x2="843.5" y1="473.5254" y2="473.5254"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80" x="704" y="468.7832">entityRefFor(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="784" y="468.7832">entityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="836" y="468.7832">)</text><polygon fill="#181818" points="705.5,498.8359,695.5,502.8359,705.5,506.8359,701.5,502.8359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="699.5" x2="853.5" y1="502.8359" y2="502.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="747" y="498.0938">recipient</text><polygon fill="#181818" points="985.5,528.1465,995.5,532.1465,985.5,536.1465,989.5,532.1465" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="694.5" x2="991.5" y1="532.1465" y2="532.1465"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="5" x="827" y="527.4043">?</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="836" y="527.4043">cmd</text><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="1054.5" y1="556.457" y2="556.457"/><line style="stroke:#181818;stroke-width:1.0;" x1="1054.5" x2="1054.5" y1="556.457" y2="569.457"/><line style="stroke:#181818;stroke-width:1.0;" x1="1013.5" x2="1054.5" y1="569.457" y2="569.457"/><polygon fill="#181818" points="1023.5,565.457,1013.5,569.457,1023.5,573.457,1019.5,569.457" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="110" x="1019.5" y="551.7148">handleCommand(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1129.5" y="551.7148">cmd</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1158.5" y="551.7148">)</text><path d="M273,589.457 L340,589.457 L340,596.7676 L330,606.7676 L273,606.7676 L273,589.457 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="234.1738" style="stroke:#000000;stroke-width:1.5;" width="937.5" x="273" y="589.457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="288" y="603.0254">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="224" x="355" y="602.0918">[recovering from latest saved snapshot]</text><line style="stroke:#181818;stroke-width:1.0;" x1="1012.5" x2="1054.5" y1="628.0781" y2="628.0781"/><line style="stroke:#181818;stroke-width:1.0;" x1="1054.5" x2="1054.5" y1="628.0781" y2="641.0781"/><line style="stroke:#181818;stroke-width:1.0;" x1="1013.5" x2="1054.5" y1="641.0781" y2="641.0781"/><polygon fill="#181818" points="1023.5,637.0781,1013.5,641.0781,1023.5,645.0781,1019.5,641.0781" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="1019.5" y="623.3359">stash</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1057.5" y="623.3359">cmd</text><line style="stroke:#181818;stroke-width:1.0;" x1="1012.5" x2="1054.5" y1="685.6992" y2="685.6992"/><line style="stroke:#181818;stroke-width:1.0;" x1="1054.5" x2="1054.5" y1="685.6992" y2="698.6992"/><line style="stroke:#181818;stroke-width:1.0;" x1="1013.5" x2="1054.5" y1="698.6992" y2="698.6992"/><polygon fill="#181818" points="1023.5,694.6992,1013.5,698.6992,1023.5,702.6992,1019.5,698.6992" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="1019.5" y="665.6465">initialize entity</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1117.5" y="665.6465">state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="1154.5" y="665.6465">with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="1020" y="680.957">the latest saved</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="62" x="1123" y="680.957">snapshot</text><path d="M283,713.6992 L357,713.6992 L357,721.0098 L347,731.0098 L283,731.0098 L283,713.6992 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="102.9316" style="stroke:#000000;stroke-width:1.5;" width="917.5" x="283" y="713.6992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="298" y="727.2676">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="216" x="372" y="726.334">[all events after latest saved snapshot]</text><polygon fill="#181818" points="995.5,748.3203,1005.5,752.3203,995.5,756.3203,999.5,752.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="320.5" x2="1001.5" y1="752.3203" y2="752.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="39" x="644.5" y="747.5781">revent</text><line style="stroke:#181818;stroke-width:1.0;" x1="1017.5" x2="1059.5" y1="781.6309" y2="781.6309"/><line style="stroke:#181818;stroke-width:1.0;" x1="1059.5" x2="1059.5" y1="781.6309" y2="794.6309"/><line style="stroke:#181818;stroke-width:1.0;" x1="1018.5" x2="1059.5" y1="794.6309" y2="794.6309"/><polygon fill="#181818" points="1028.5,790.6309,1018.5,794.6309,1028.5,798.6309,1024.5,794.6309" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80" x="1024.5" y="776.8887">handleEvent(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1104.5" y="776.8887">state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="51" x="1137.5" y="776.8887">, revent)</text><polygon fill="#181818" points="331.5,804.6309,321.5,808.6309,331.5,812.6309,327.5,808.6309" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="325.5" x2="1001.5" y1="808.6309" y2="808.6309"/><path d="M273,837.6309 L340,837.6309 L340,844.9414 L330,854.9414 L273,854.9414 L273,837.6309 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="218.8633" style="stroke:#000000;stroke-width:1.5;" width="927.5" x="273" y="837.6309"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="288" y="851.1992">opt</text><line style="stroke:#181818;stroke-width:1.0;" x1="1012.5" x2="1054.5" y1="876.252" y2="876.252"/><line style="stroke:#181818;stroke-width:1.0;" x1="1054.5" x2="1054.5" y1="876.252" y2="889.252"/><line style="stroke:#181818;stroke-width:1.0;" x1="1013.5" x2="1054.5" y1="889.252" y2="889.252"/><polygon fill="#181818" points="1023.5,885.252,1013.5,889.252,1023.5,893.252,1019.5,889.252" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="1019.5" y="871.5098">persist(events)</text><path d="M283,904.252 L357,904.252 L357,911.5625 L347,921.5625 L283,921.5625 L283,904.252 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="145.2422" style="stroke:#000000;stroke-width:1.5;" width="907.5" x="283" y="904.252"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="298" y="917.8203">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="119" x="372" y="916.8867">[for event &lt;- events]</text><line style="stroke:#181818;stroke-width:1.0;" x1="1012.5" x2="1054.5" y1="942.873" y2="942.873"/><line style="stroke:#181818;stroke-width:1.0;" x1="1054.5" x2="1054.5" y1="942.873" y2="955.873"/><line style="stroke:#181818;stroke-width:1.0;" x1="1013.5" x2="1054.5" y1="955.873" y2="955.873"/><polygon fill="#181818" points="1023.5,951.873,1013.5,955.873,1023.5,959.873,1019.5,955.873" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="1019.5" y="938.1309">tagEvent(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="1077.5" y="938.1309">entityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1129.5" y="938.1309">, event)</text><polygon fill="#181818" points="336.5,981.1836,326.5,985.1836,336.5,989.1836,332.5,985.1836" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="330.5" x2="1001.5" y1="985.1836" y2="985.1836"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="588.5" y="980.4414">persist event with tag(s)</text><polygon fill="#181818" points="990.5,995.1836,1000.5,999.1836,990.5,1003.1836,994.5,999.1836" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="320.5" x2="996.5" y1="999.1836" y2="999.1836"/><line style="stroke:#181818;stroke-width:1.0;" x1="1012.5" x2="1054.5" y1="1028.4941" y2="1028.4941"/><line style="stroke:#181818;stroke-width:1.0;" x1="1054.5" x2="1054.5" y1="1028.4941" y2="1041.4941"/><line style="stroke:#181818;stroke-width:1.0;" x1="1013.5" x2="1054.5" y1="1041.4941" y2="1041.4941"/><polygon fill="#181818" points="1023.5,1037.4941,1013.5,1041.4941,1023.5,1045.4941,1019.5,1041.4941" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80" x="1019.5" y="1023.752">handleEvent(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1099.5" y="1023.752">state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1132.5" y="1023.752">, event)</text><polygon fill="#181818" points="705.5,1080.8047,695.5,1084.8047,705.5,1088.8047,701.5,1084.8047" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="699.5" x2="1001.5" y1="1084.8047" y2="1084.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="39" x="773.5" y="1080.0625">result</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="812.5" y="1080.0625">: CommandResult</text><polygon fill="#181818" points="521.5,1110.1152,511.5,1114.1152,521.5,1118.1152,517.5,1114.1152" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="515.5" x2="688.5" y1="1114.1152" y2="1114.1152"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="39" x="525" y="1109.373">result</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="564" y="1109.373">: CommandResult</text><polygon fill="#181818" points="331.5,1139.4258,321.5,1143.4258,331.5,1147.4258,327.5,1143.4258" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="325.5" x2="494.5" y1="1143.4258" y2="1143.4258"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="373" y="1138.6836">writeOffset</text><!--MD5=[1c7b87fab664937d6d38f0d51f8123ea]
@startuml EventProcessorStream
hide footbox
skinparam ParticipantPadding 20
skinparam BoxPadding 10
skinparam sequenceMessageAlign center
skinparam monochrome true

box#AntiqueWhite
boundary "External Bounded Context" as ebc
end box

database Journal as j
queue "Event \nProcessor Stream\ntag = 'domain-to-external'" as eps
control "Entity Pattern" as ep
participant "Cluster Sharding" as cs
entity "Entity Behavior" as eb

eps -> eps++: init
eps -> j++: readOffset()
return **offset**
eps -> j: readEventsByTag(**offset**)
note right : **stream** of events with the tag "domain-to-external" \nfrom the specified offset

ebc -> j++: persist domain event with tag\n Set("domain-to-external", ...)
return

j - ->> eps: **devent**
eps -> eps++: processEvent(**devent**)
eps -> ep++: ? (**entityId**, **cmd**)
note right: **entityId** should be specified or inferred \nfrom one of the event properties
ep -> ep : ref(**entityId**)
ep -> cs++: entityRefFor(**entityId**)
return recipient
ep -> eb++: ? **cmd**

eb -> eb++: handleCommand(**cmd**)
opt recovering from latest saved snapshot
eb -> eb: stash **cmd**
eb -> eb: initialize entity **state** with \nthe latest saved **snapshot**
loop all events after latest saved snapshot
j -> eb++: revent
eb -> eb: handleEvent(**state**, revent)
eb - -> j- -
end
end

opt
eb -> eb: persist(events)
loop for event <- events
eb -> eb: tagEvent(**entityId**, event)
eb -> j++: persist event with tag(s)
return
eb -> eb: handleEvent(**state**, event)
end
end
eb- -
return **result**: CommandResult

ep -> eps- -: **result**: CommandResult
eps - -> j- - :writeOffset

@enduml

PlantUML version 1.2022.12(Sun Oct 23 20:12:26 CEST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: fr
Country: FR
--></g></svg>